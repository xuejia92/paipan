<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Expires" content="0">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-control" content="no-cache,must-revalidate">
	<meta http-equiv="Cache" content="no-cache">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
	<link rel="stylesheet" href="./layui/css/layui.css"> 
	<script src="./jquery.js"></script> 
	<script src="./layui/layui.js"></script>  
  <script src="./FileSaver.js"></script>
	<title>六爻排盘</title>
</head>
<body class="no-cache">
	<h1 align="center" style="padding-left: 10%;">六爻排盘记录 
	</h1> 
  
  <br>
  <div  class="layui-btn-group">
      <button style="width: 50%;" type="button" id="fanhui" class="layui-btn layui-btn-fluid">返回排盘</button>
      <input style="width: 50%;float: left;" type="file" id="input" class="layui-btn layui-btn-warm">         
      <input style="width: 100%;" type="button" value="导出数据" id="output" class="layui-btn layui-btn-danger"/>
  </div>
  <br>
  <br>
<table  border="1" style="    width: 100%; text-align: center;line-height: 170%;" id="hjhj">
  <th>占卜标题</th><th>时间</th> <th>爻位</th><th>批注</th> <th>操作</th>
</table> 
<script> 
var form = layui.form
  ,layer = layui.layer 
  ,laydate = layui.laydate; 
  localData = localStorage.getItem("data")
  localData = JSON.parse(localData) 
  if(localData!=null){
    for(var i=0;i<localData.length;i++){
      yao = localData[i]["yao1"]+localData[i]["yao2"]+localData[i]["yao3"]+localData[i]["yao4"]+localData[i]["yao5"]+localData[i]["yao6"]
      if(localData[i]['remark']==undefined) localData[i]['remark']="";
      $("#hjhj").append("<tr><td><a style='color:blue;' href='javascript:void(0);' attr="+i+" class='see'>"+localData[i]["title"]+"</a></td><td>"+localData[i]['datetime']+"</td><td>"+yao+"</td><td><a class='remark layui-btn layui-btn-warm layui-btn-xs' href='javascript:void(0);' attr="+i+">批注</a></td><td><a class='mod layui-btn layui-btn-normal layui-btn-xs' href='javascript:void(0);' attr="+i+">修改</a><a class='del layui-btn layui-btn-danger layui-btn-xs' href='javascript:void(0);' attr="+i+">删除</a></td></tr>");
    }  
  }
   

  $('.see').click(function(){
    var index = $(this).attr('attr');
    localData = localStorage.getItem("data")
    localData = JSON.parse(localData)
    console.log(localData[index],index)
    data = localData[index]
    data['yuerizhi']=data['yuerizhi']==undefined?"":data['yuerizhi']
    location.href = "index.html?leibie=1&title="+data['title']+"&datetime="+data['datetime']+"&yao1="+data['yao1']+"&yao2="+data['yao2']+"&yao3="+data['yao3']+"&yao4="+data['yao4']+"&yao5="+data['yao5']+"&yao6="+data['yao6']+"&yuerizhi="+data['yuerizhi'];
  });

  $(".mod").click(function(){
    var index = $(this).attr('attr');
    localData = localStorage.getItem("data")
    localData = JSON.parse(localData)
    console.log(localData[index],index)
    data = localData[index] 
    if(localData[index]["remark"]==undefined){
      var name = prompt("请输入批注", "");
    }else{
      var name = prompt("请输入批注", localData[index]["remark"]);
    }
    
    if(name){
      localData[index]["remark"] = name;
      localStorage.setItem("data",JSON.stringify(localData)) 
      layer.msg("更新成功", {icon: 1,time:1000},function(){
          location.href="./record.html"
      });
    }
  });

  $('.del').click(function(){
    var index = $(this).attr('attr');
    localData = localStorage.getItem("data")
    localData = JSON.parse(localData)
    if(layer.confirm('确定删除吗？', {
      btn: ['确定','取消'] //按钮
    }, function(){ 
      var linshi = []
      for(var i=0;i<localData.length;i++){
        if(i!=index){
          linshi.push(localData[i])
        }
      }  
      localStorage.setItem("data",JSON.stringify(linshi)) 
      layer.msg("删除成功", {icon: 1,time:1000},function(){
          location.href="./record.html"
       });  
      return false;
    }, function(){
      layer.msg('取消删除', {icon: 5});
    }));
  });

  $('.remark').click(function(){
    var index = $(this).attr('attr');
    localData = localStorage.getItem("data")
    localData = JSON.parse(localData)
    if(localData[index]["remark"]==undefined){
      layer.msg("暂无批注");
    } else{
      layer.msg(localData[index]["remark"], {icon: 1,time:6000});
    } 
  });
    

  $("#fanhui").click(function(){
    location.href="./index.html";
  });

  function isJSON(str) {
      if (typeof str == 'string') {
          try {
              var obj=JSON.parse(str);
              if(typeof obj == 'object' && obj ){
                  return true;
              }else{
                  return false;
              }

          } catch(e) {
              console.log('error：'+str+'!!!'+e);
              return false;
          }
      }
      return false;
  }

  // 导入
 $("#input").change(function(e){
     var file=e.target.files[0];
     var reader = new FileReader();
     reader.onload = function(e){ 
       if(!isJSON(e.target.result)){
        layer.msg('导入失败，请检查文件内容是否为json数据', {icon: 5});
           return false; 
       }
       var jsonData = JSON.parse(e.target.result)
       for(var i=0;i<jsonData.length;i++){ 
         if(jsonData[i]["title"]==undefined || jsonData[i]["datetime"]==undefined || jsonData[i]["yao1"]==undefined || jsonData[i]["yao2"]==undefined || jsonData[i]["yao3"]==undefined || jsonData[i]["yao4"]==undefined || jsonData[i]["yao5"]==undefined || jsonData[i]["yao6"]==undefined){
           layer.msg('导入失败，请检查文件内容格式', {icon: 5});
           return false;
         } 
       }
       localStorage.setItem("data",e.target.result);    
       layer.msg("更新数据成功", {icon: 1,time:1000},function(){
          location.href="./record.html"
       }); 
     };
     reader.readAsText(file);
 });
 //导出
 $("#output").click(function(){
     var content =localStorage.getItem("data");    
     if(content==null) {
        layer.msg("没有数据", {icon: 5});
        return;
     } 
     var blob = new Blob([content], {type: "text/plain;charset=utf-8"});
     saveAs(blob, "save.txt");
 });
</script>
</body>
</html>